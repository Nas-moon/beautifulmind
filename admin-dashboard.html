<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Beautiful Mind</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f5f5;
  color: #222;
}

header {
  background: #1b5583;
  color: white;
  padding: 1.5rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 800;
}

.logout-link {
  background: rgba(231, 76, 60, 0.8);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
}

.logout-link:hover {
  background: rgba(231, 76, 60, 1);
  transform: translateY(-2px);
}

main {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

.tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid #ddd;
}

.tab-btn {
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  font-size: 1rem;
}

.tab-btn.active {
  color: #1b5583;
  border-bottom-color: #1b5583;
}

.tab-btn:hover {
  color: #1b5583;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.students-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.student-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-left: 4px solid #1b5583;
}

.student-name {
  font-size: 1.2rem;
  font-weight: 700;
  color: #1b5583;
  margin-bottom: 0.5rem;
}

.student-email {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.student-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.stat {
  background: #f0f8ff;
  padding: 0.75rem;
  border-radius: 8px;
  text-align: center;
}

.stat-val {
  font-size: 1.5rem;
  font-weight: 900;
  color: #ffd700;
}

.stat-label {
  font-size: 0.8rem;
  color: #666;
  margin-top: 0.25rem;
}

.submissions-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.submissions-table th {
  background: #1b5583;
  color: white;
  padding: 1rem;
  text-align: left;
  font-weight: 700;
}

.submissions-table td {
  padding: 1rem;
  border-bottom: 1px solid #eee;
}

.submissions-table tr:hover {
  background: #f9f9f9;
}

.download-btn {
  background: #1b5583;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.download-btn:hover {
  background: #0f3c5f;
  transform: translateY(-2px);
}

.loading {
  text-align: center;
  padding: 2rem;
  color: #666;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    gap: 1rem;
  }

  .students-grid {
    grid-template-columns: 1fr;
  }

  .submissions-table {
    font-size: 0.9rem;
  }

  .submissions-table th,
  .submissions-table td {
    padding: 0.5rem;
  }
}
</style>
</head>
<body>

<header>
  <h1>üë®‚Äçüíº Admin Dashboard</h1>
  <button class="logout-link" onclick="logout()">üö™ Logout</button>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('students')">üë• Students</button>
    <button class="tab-btn" onclick="switchTab('submissions')">üìÅ Submissions</button>
  </div>

  <!-- STUDENTS TAB -->
  <div id="students" class="tab-content active">
    <div id="studentsList" class="students-grid">
      <div class="loading">Loading students...</div>
    </div>
  </div>

  <!-- SUBMISSIONS TAB -->
  <div id="submissions" class="tab-content">
    <table class="submissions-table">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Email</th>
          <th>Assignment</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="submissionsTable">
        <tr>
          <td colspan="5" style="text-align: center; padding: 2rem;">Loading submissions...</td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<script type="module">
import { getCurrentUser, logoutStudent } from '../firebase-config.js';
import { db } from '../firebase-config.js';
import { ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// Check if admin
const user = getCurrentUser();
if (!user || user.role !== 'admin') {
  alert('‚ùå Admin access only');
  window.location.href = '../login.html';
}

console.log('‚úÖ Admin logged in:', user.name);

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  
  document.getElementById(tab).classList.add('active');
  event.target.classList.add('active');
}

async function logout() {
  if (confirm('Logout?')) {
    await logoutStudent();
    window.location.href = '../login.html';
  }
}

// Load students
async function loadStudents() {
  try {
    const snapshot = await get(ref(db, 'users'));
    const studentsList = document.getElementById('studentsList');
    studentsList.innerHTML = '';

    if (snapshot.exists()) {
      const allUsers = Object.values(snapshot.val())
        .filter(u => u.role === 'student')
        .sort((a, b) => (b.stars || 0) - (a.stars || 0));

      allUsers.forEach((student, index) => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
          <div class="student-name">#${index + 1} - ${student.name}</div>
          <div class="student-email">${student.email}</div>
          <div class="student-stats">
            <div class="stat">
              <div class="stat-val">‚≠ê ${student.stars || 0}</div>
              <div class="stat-label">Total Stars</div>
            </div>
            <div class="stat">
              <div class="stat-val">${student.lessons || 0}/5</div>
              <div class="stat-label">Lessons</div>
            </div>
          </div>
        `;
        studentsList.appendChild(card);
      });
    }
  } catch (error) {
    console.error('Error loading students:', error);
  }
}

// Load submissions
async function loadSubmissions() {
  try {
    const snapshot = await get(ref(db, 'assignments'));
    const tbody = document.getElementById('submissionsTable');
    tbody.innerHTML = '';

    if (snapshot.exists()) {
      const assignments = snapshot.val();
      
      Object.entries(assignments).forEach(([uid, userAssignments]) => {
        Object.entries(userAssignments).forEach(([assignmentType, data]) => {
          const row = document.createElement('tr');
          
          // Get student name from users
          get(ref(db, `users/${uid}`)).then(snap => {
            if (snap.exists()) {
              const student = snap.val();
              row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.email}</td>
                <td>${assignmentType}</td>
                <td>${new Date(data.uploadedAt).toLocaleDateString()}</td>
                <td>
                  <button class="download-btn" onclick="downloadFile('${uid}', '${assignmentType}', '${data.fileName}')">
                    üì• Download
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            }
          });
        });
      });

      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No submissions yet</td></tr>';
      }
    } else {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No submissions yet</td></tr>';
    }
  } catch (error) {
    console.error('Error loading submissions:', error);
  }
}

// Download file
window.downloadFile = async (uid, assignmentType, fileName) => {
  try {
    const snapshot = await get(ref(db, `assignments/${uid}/${assignmentType}`));
    if (snapshot.exists()) {
      const data = snapshot.val();
      
      // Convert base64 to blob
      const arr = data.fileData;
      const blob = new Blob([new Uint8Array(Object.values(arr))], { type: data.fileType });
      
      // Create download link
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  } catch (error) {
    alert('‚ùå Error downloading file: ' + error.message);
  }
};

// Initialize
loadStudents();
loadSubmissions();
</script>

</body>
</html>
