<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lesson 1 ‚Äì Topic 3</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #eef4fa;
  color: #222;
}

header {
  background: #1b5583;
  color: white;
  padding: 1rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

header h1 {
  margin: 0.5em 0;
  font-size: 1.2rem;
  font-weight: 800;
}

.heado {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-btns {
  display: flex;
  gap: 10px;
  align-items: center;
}

.back, .map-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-family: 'Segoe UI', Verdana;
  font-weight: bold;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back {
  background-color: #e6eef4;
  color: #1b5583;
}

.back:hover { 
  background-color: #dbe7f0;
  transform: translateY(-2px);
}

.map-btn {
  background-color: #ffd700;
  color: #0f2f4a;
  font-weight: bold;
}

.map-btn:hover { 
  background-color: #ffc800;
  transform: translateY(-2px);
}

main {
  max-width: 900px;
  margin: 2rem auto;
  padding: 1.5rem;
  background: white;
  border-radius: 1.5rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

h2 { 
  color: #1b5583;
  margin-bottom: 1rem;
  font-size: 1.8rem;
}

.video-wrapper {
  margin-bottom: 1.5rem;
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.video-wrapper iframe {
  width: 100%;
  height: 450px;
  border: none;
  display: block;
}

button#nextBtn {
  background: linear-gradient(135deg, #1b5583, #0f3c5f);
  color: white;
  border: none;
  padding: 0.8rem 1.4rem;
  border-radius: 0.6rem;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(27, 85, 131, 0.3);
}

button#nextBtn:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(27, 85, 131, 0.4);
}

button#nextBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}

#progress {
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #666;
  font-weight: 600;
}

#star-bar {
  position: fixed;
  top: 1rem;
  right: 1.5rem;
  background: #fff;
  padding: 0.5rem 1rem;
  border-radius: 1rem;
  font-size: 1.2rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  z-index: 1000;
  border: 2px solid #ffd700;
}

.star {
  position: fixed;
  font-size: 2rem;
  z-index: 9999;
  pointer-events: none;
  animation: fly 1s ease-in-out forwards;
}

@keyframes fly {
  0%   { transform: scale(1) translate(0,0); opacity: 1; }
  100% { transform: scale(0.3) translate(300px,-300px); opacity: 0; }
}

.confetti {
  position: fixed;
  width: 8px;
  height: 8px;
  background: #ffd700;
  top: 50%;
  left: 50%;
  opacity: 0.9;
  animation: fall 1s ease-out forwards;
  z-index: 1000;
  pointer-events: none;
}

@keyframes fall {
  to {
    transform: translate(
      calc(-100px + 200px * var(--x)),
      calc(200px + 300px * var(--y))
    );
    opacity: 0;
  }
}

@media (max-width: 768px) {
  .heado {
    flex-direction: column;
    gap: 10px;
  }

  .header-btns {
    width: 100%;
    gap: 10px;
  }

  .back, .map-btn {
    flex: 1;
    padding: 10px;
  }

  main {
    margin: 1rem;
    padding: 1rem;
  }

  .video-wrapper iframe {
    height: 300px;
  }

  #star-bar {
    top: auto;
    bottom: 80px;
    right: 1rem;
    left: auto;
  }
}
</style>
</head>

<body>

<header>
  <div class="heado">
    <h1>Lesson 1 ‚Ä¢ Topic 3 - Qualities of Beautiful Mind</h1>
    <div class="header-btns">
      <button class="back" onclick="history.back()">‚Üê Back</button>
      <button class="map-btn" onclick="window.location.href='../lessonmap/lesson-map.html'">üó∫Ô∏è Map</button>
    </div>
  </div>
</header>

<main>
  <div id="star-bar">‚≠ê <span id="star-count">0</span></div>

  <h2>Qualities of Beautiful Mind</h2>

  <div class="video-wrapper">
    <iframe
      src="https://drive.google.com/file/d/16PklFqZwairzSsl-kK7f0d6nO4aXSyp3/preview"
      allow="autoplay"
      allowfullscreen
    ></iframe>
  </div>

  <button id="nextBtn" disabled>Proceed to Quiz ‚Üí</button>
  
  <p id="progress">
    ‚è±Ô∏è <span id="timerText">0/10</span> - Watch to unlock
  </p>
</main>

<script type="module">
import { getCurrentUser } from '../firebase-config.js';
import { completeTopicInFirebase, getProgressData } from '../progress-manager.js';

// ============================================
// CONFIG - CHANGE FOR EACH PAGE
// ============================================
const VIDEO_DURATION = 250; // 10 seconds timer
const TOPIC_ID = "l1topic3";
const STARS_TO_EARN = 10;
const NEXT_PAGE = "l1quiz.html";
// ============================================

const nextBtn = document.getElementById("nextBtn");
const progress = document.getElementById("progress");
const starCountEl = document.getElementById("star-count");
const timerText = document.getElementById("timerText");

// Check authentication
const user = getCurrentUser();
if (!user) {
  alert('‚ùå Not authenticated');
  window.location.href = '../login.html';
}

console.log('‚úÖ User:', user.name, 'UID:', user.uid, '| Topic:', TOPIC_ID);

let topicCompleted = false;
let starsEarned = false;

// Load current stars
async function loadCurrentStars() {
  const progressData = await getProgressData(user.uid);
  starCountEl.textContent = progressData.stars;
}

// Check if already completed
async function checkCompletion() {
  const progressData = await getProgressData(user.uid);
  
  if (progressData.completedTopics[TOPIC_ID]) {
    topicCompleted = true;
    starsEarned = true;
    nextBtn.disabled = false;
    progress.textContent = "‚úÖ Already completed! Click to proceed.";
    console.log('‚úÖ Topic already completed before');
  } else {
    startTimer();
  }
}

function startTimer() {
  let secondsWatched = 0;

  const timerInterval = setInterval(() => {
    secondsWatched++;
    timerText.textContent = `${secondsWatched}/${VIDEO_DURATION}`;

    if (secondsWatched >= VIDEO_DURATION) {
      clearInterval(timerInterval);
      unlockAndEarnStars();
    }
  }, 1000);
}

// Unlock button AND earn stars when timer completes
async function unlockAndEarnStars() {
  if (starsEarned) return; // Prevent double earning
  
  console.log('‚è±Ô∏è Timer finished - earning stars...');
  starsEarned = true;

  nextBtn.disabled = false;
  progress.innerHTML = '‚úÖ Video watched! Click to proceed.';
  
  // Immediately save progress to Firebase
  const result = await completeTopicInFirebase(user.uid, TOPIC_ID, STARS_TO_EARN);
  
  if (result.success) {
    starCountEl.textContent = result.totalStars;
    console.log(`‚úÖ Stars earned! Total: ${result.totalStars}`);
    rewardAnimation();
  } else {
    console.error('‚ùå Error earning stars:', result.error);
  }
}

// Button click just navigates to next page (no star earning here)
nextBtn.addEventListener('click', async () => {
  if (nextBtn.disabled) return;

  console.log('‚Üí Proceeding to next topic...');
  nextBtn.disabled = true;
  nextBtn.textContent = 'Loading...';

  // Small delay for UX, then navigate
  setTimeout(() => {
    window.location.href = NEXT_PAGE;
  }, 500);
});

function rewardAnimation() {
  flyStar();
  confettiBurst();
}

function flyStar() {
  const star = document.createElement("div");
  star.className = "star";
  star.textContent = "‚≠ê";
  star.style.left = "50%";
  star.style.top = "50%";
  document.body.appendChild(star);
  setTimeout(() => star.remove(), 1000);
}

function confettiBurst() {
  for (let i = 0; i < 15; i++) {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.setProperty("--x", Math.random());
    c.style.setProperty("--y", Math.random());
    c.style.background = ["#ffd700", "#ff6b6b", "#ffed4e"][i % 3];
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 1000);
  }
}

// Initialize
loadCurrentStars();
checkCompletion();
</script>

</body>
</html>
