<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lesson 4 - Quiz</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(#0f3d5e, #0b2e47);
  color: white;
  min-height: 100vh;
}

header {
  padding: 1rem 2rem;
  background: #1b5583;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

header h2 {
  font-size: 1.3rem;
  font-weight: 800;
}

.timer {
  font-weight: bold;
  background: #fff;
  color: #1b5583;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 1.1rem;
}

main {
  max-width: 700px;
  margin: 2rem auto;
  background: white;
  color: #222;
  padding: 2rem;
  border-radius: 1.5rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.question {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: #1b5583;
}

.options button {
  display: block;
  width: 100%;
  margin: 0.8rem 0;
  padding: 1rem;
  border-radius: 10px;
  border: 2px solid #1b5583;
  background: #eef4fa;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.3s;
  text-align: left;
}

.options button:hover:not(:disabled) {
  background: #dbe7f0;
  transform: translateX(5px);
}

.options button:disabled {
  cursor: not-allowed;
}

.options button.correct {
  background: #c8f7c5;
  border-color: #2ecc71;
  box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
}

.options button.wrong {
  background: #f7c5c5;
  border-color: #e74c3c;
  box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.footer {
  margin-top: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 2px solid #eee;
}

.stars {
  font-weight: bold;
  color: #ffd700;
  font-size: 1.1rem;
}

.progress {
  color: #666;
  font-weight: 600;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: #666;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    gap: 1rem;
  }

  main {
    margin: 1rem;
    padding: 1rem;
  }

  .question {
    font-size: 1rem;
  }

  .options button {
    padding: 0.8rem;
    font-size: 0.9rem;
  }
}
</style>
</head>

<body>

<header>
  <h2>Lesson 4 ‚Ä¢ Rapid Quiz</h2>
  <div class="timer" id="timer">05:00</div>
</header>

<main>
  <div class="question" id="question"></div>
  <div class="options" id="options"></div>
  <div class="footer">
    <div class="stars">‚≠ê Earned: <span id="stars">0</span></div>
    <div class="progress">Question <span id="qNum">1</span>/10</div>
  </div>
</main>

<script type="module">
import { getCurrentUser } from '../firebase-config.js';
import { completeQuizInFirebase, getProgressData } from '../progress-manager.js';

// ============================================
// CONFIG
// ============================================
const QUIZ_ID = "quiz_l4";
const LESSON_NUMBER = 4;
const STARS_PER_QUESTION = 3;
const TOTAL_TIME = 300; // 5 minutes in seconds
const MAP_PATH = "../lessonmap/lesson-map.html";
// ============================================

// Quiz Questions (10 selected from 15)
const quiz = [
  {
  q: "Listening helps us to ____.",
  options: ["A) Sleep", "B) Understand clearly", "C) Ignore others", "D) Argue more"],
  answer: 2,
},
{
  q: "Active listening means listening with your ____.",
  options: ["A) Eyes only", "B) Ears only", "C) Full attention and mind", "D) Friends"],
  answer: 3,
},
{
  q: "Which of the following shows active listening?",
  options: ["A) Looking at phone", "B) Interrupting", "C) Making eye contact", "D) Talking continuously"],
  answer: 3,
},
{
  q: "Listening without judgement means ____.",
  options: ["A) Laughing at others", "B) Criticizing quickly", "C) Allowing others to finish speaking", "D) Ignoring ideas"],
  answer: 3,
},
{
  q: "Listening helps avoid ____.",
  options: ["A) Knowledge", "B) Respect", "C) Mistakes", "D) Friends"],
  answer: 3,
},
{
  q: "The lowest level of listening is ____.",
  options: ["A) Empathic listening", "B) Attentive listening", "C) Hearing", "D) Selective listening"],
  answer: 3,
},
{
  q: "Listening only to what you like is called ____.",
  options: ["A) Active listening", "B) Selective listening", "C) Empathic listening", "D) Attentive listening"],
  answer: 2,
},
{
  q: "The highest level of listening is ____.",
  options: ["A) Hearing", "B) Pretend listening", "C) Empathic listening", "D) Selective listening"],
  answer: 3,
},
{
  q: "Pretend listening means ____.",
  options: ["A) Fully concentrating", "B) Listening with feelings", "C) Acting like listening but thinking something else", "D) Asking questions"],
  answer: 3,
},
{
  q: "Attentive listening requires ____.",
  options: ["A) Distraction", "B) Focus", "C) Ego", "D) Anger"],
  answer: 2,
},
];

// Check authentication
const user = getCurrentUser();
if (!user) {
  alert('‚ùå Not authenticated');
  window.location.href = '../login.html';
}

// Check if already completed
async function checkQuizCompletion() {
  const progressData = await getProgressData(user.uid);
  if (progressData.completedQuizzes[QUIZ_ID]) {
    alert("‚úÖ You have already completed this quiz.");
    window.location.href = MAP_PATH;
  }
}

checkQuizCompletion();

let index = 0;
let totalStars = 0;

const questionEl = document.getElementById("question");
const optionsEl = document.getElementById("options");
const starsEl = document.getElementById("stars");
const qNumEl = document.getElementById("qNum");
const timerEl = document.getElementById("timer");

function loadQuestion() {
  const current = quiz[index];
  questionEl.textContent = current.q;
  optionsEl.innerHTML = "";
  qNumEl.textContent = index + 1;

  current.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => selectAnswer(btn, i, current.answer);
    optionsEl.appendChild(btn);
  });
}

function selectAnswer(button, selected, correctAnswer) {
  const buttons = optionsEl.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);

  if (selected === correctAnswer) {
    button.classList.add("correct");
    totalStars += STARS_PER_QUESTION;
    starsEl.textContent = totalStars;
  } else {
    button.classList.add("wrong");
    buttons[correctAnswer].classList.add("correct");
  }

  setTimeout(() => {
    index++;
    if (index < quiz.length) {
      loadQuestion();
    } else {
      endQuiz();
    }
  }, 900);
}

// Timer
let time = TOTAL_TIME;
const countdown = setInterval(() => {
  time--;
  const min = String(Math.floor(time / 60)).padStart(2, "0");
  const sec = String(time % 60).padStart(2, "0");
  timerEl.textContent = `${min}:${sec}`;

  if (time <= 0) {
    clearInterval(countdown);
    endQuiz();
  }
}, 1000);

async function endQuiz() {
  clearInterval(countdown);

  // Calculate score percentage
  const scorePercent = Math.round((totalStars / (quiz.length * STARS_PER_QUESTION)) * 100);

  console.log(`üìä Quiz Complete - Score: ${scorePercent}% | Stars: ${totalStars}`);

  // Save to Firebase
  const result = await completeQuizInFirebase(user.uid, QUIZ_ID, totalStars, scorePercent);

  if (result.success) {
    alert(`üéâ Quiz Complete!\n\n‚≠ê Stars Earned: ${totalStars}\nüìä Score: ${scorePercent}%`);
    
    // Check if lesson complete
    if (result.lessonsCompleted >= LESSON_NUMBER) {
      alert('üéä Lesson Complete!');
    }

    window.location.href = MAP_PATH;
  } else {
    alert('‚ùå Error saving quiz: ' + result.error);
  }
}

// Start
loadQuestion();
</script>

</body>
</html>
