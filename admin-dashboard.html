<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Beautiful Mind</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f5f5;
  color: #222;
}

header {
  background: #1b5583;
  color: white;
  padding: 1.5rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 800;
}

.header-buttons {
  display: flex;
  gap: 10px;
}

.upload-questions-btn {
  background: #ffd700;
  color: #0f2f4a;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.upload-questions-btn:hover {
  background: #ffc800;
  transform: translateY(-2px);
}

.logout-link {
  background: rgba(231, 76, 60, 0.8);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.logout-link:hover {
  background: rgba(231, 76, 60, 1);
  transform: translateY(-2px);
}

main {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

.tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid #ddd;
}

.tab-btn {
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  font-size: 1rem;
}

.tab-btn.active {
  color: #1b5583;
  border-bottom-color: #1b5583;
}

.tab-btn:hover {
  color: #1b5583;
}

.tab-content {
  display: none !important;
}

.tab-content.active {
  display: block !important;
}

.students-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.student-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-left: 4px solid #1b5583;
}

.student-name {
  font-size: 1.2rem;
  font-weight: 700;
  color: #1b5583;
  margin-bottom: 0.5rem;
}

.student-email {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.student-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.stat {
  background: #f0f8ff;
  padding: 0.75rem;
  border-radius: 8px;
  text-align: center;
}

.stat-val {
  font-size: 1.5rem;
  font-weight: 900;
  color: #ffd700;
}

.stat-label {
  font-size: 0.8rem;
  color: #666;
  margin-top: 0.25rem;
}

.submissions-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.submissions-table th {
  background: #1b5583;
  color: white;
  padding: 1rem;
  text-align: left;
  font-weight: 700;
}

.submissions-table td {
  padding: 1rem;
  border-bottom: 1px solid #eee;
}

.submissions-table tr:hover {
  background: #f9f9f9;
}

.download-btn {
  background: #1b5583;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.3s;
}

.download-btn:hover {
  background: #0f3c5f;
  transform: translateY(-2px);
}

.loading {
  text-align: center;
  padding: 2rem;
  color: #666;
  font-size: 1.1rem;
}

.no-data {
  text-align: center;
  padding: 2rem;
  color: #999;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    gap: 1rem;
  }

  .header-buttons {
    width: 100%;
  }

  .header-buttons button {
    flex: 1;
  }

  .students-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<header>
  <h1>üë®‚Äçüíº Admin Dashboard</h1>
  <div class="header-buttons">
    <button class="upload-questions-btn" id="uploadQuestionsBtn">üì§ Upload Assignment</button>
    <button class="logout-link" id="logoutBtn">üö™ Logout</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" id="studentsTabBtn" onclick="switchTab('students')">üë• Students</button>
    <button class="tab-btn" id="submissionsTabBtn" onclick="switchTab('submissions')">üìÅ Submissions</button>
  </div>

  <div id="students" class="tab-content active">
    <div id="studentsList" class="students-grid">
      <div class="loading">Loading students...</div>
    </div>
  </div>

  <div id="submissions" class="tab-content">
    <table class="submissions-table">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Email</th>
          <th>Assignment</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="submissionsTable">
        <tr><td colspan="5" style="text-align: center; padding: 2rem;">Loading submissions...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyAEMgcKGhZpui2eEYFA6T6SeYvWB51uRD0",
  authDomain: "beautifulmind-19645.firebaseapp.com",
  databaseURL: "https://beautifulmind-19645-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "beautifulmind-19645",
  storageBucket: "beautifulmind-19645.firebasestorage.app",
  messagingSenderId: "799227957055",
  appId: "1:799227957055:web:6a7397f3c43c7a9ed54d8a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

console.log('üîß Admin Dashboard loaded');

onAuthStateChanged(auth, async (user) => {
  console.log('üë§ Auth check - User:', user?.email);
  
  if (!user) {
    console.log('‚ùå No user');
    window.location.href = './login.html';
    return;
  }

  try {
    const userSnap = await get(ref(db, `users/${user.uid}`));
    if (!userSnap.exists() || userSnap.val().role !== 'admin') {
      console.log('‚ùå Not admin');
      window.location.href = './login.html';
      return;
    }
    
    console.log('‚úÖ Admin verified:', user.email);
    loadStudents();
    loadSubmissions();
    setupButtons();
  } catch (error) {
    console.error('‚ùå Error:', error);
    window.location.href = './login.html';
  }
});

function setupButtons() {
  console.log('‚öôÔ∏è Setting up buttons');
  
  document.getElementById('uploadQuestionsBtn').onclick = () => {
    console.log('üì§ Upload button clicked');
    window.location.href = './admin-upload-questions.html';
  };
  
  document.getElementById('logoutBtn').onclick = () => {
    console.log('üîì Logout button clicked');
    if (confirm('Are you sure you want to logout?')) {
      signOut(auth).then(() => {
        console.log('‚úÖ Logged out');
        window.location.href = './login.html';
      }).catch((error) => {
        console.error('‚ùå Logout error:', error);
      });
    }
  };
  
  console.log('‚úÖ Buttons set up');
}

window.switchTab = function(tabName) {
  console.log('üìë Switching to tab:', tabName);
  
  document.querySelectorAll('.tab-content').forEach(el => {
    el.classList.remove('active');
  });
  
  document.querySelectorAll('.tab-btn').forEach(el => {
    el.classList.remove('active');
  });
  
  document.getElementById(tabName).classList.add('active');
  
  if (tabName === 'students') {
    document.getElementById('studentsTabBtn').classList.add('active');
  } else if (tabName === 'submissions') {
    document.getElementById('submissionsTabBtn').classList.add('active');
  }
};

window.downloadSubmission = function(fileData, fileName) {
  console.log('üì• Downloading:', fileName);
  const link = document.createElement('a');
  link.href = fileData;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

async function loadStudents() {
  try {
    console.log('üë• Loading students...');
    const snapshot = await get(ref(db, 'users'));
    const studentsList = document.getElementById('studentsList');
    studentsList.innerHTML = '';

    if (snapshot.exists()) {
      const students = Object.entries(snapshot.val())
        .map(([uid, data]) => ({ uid, ...data }))
        .filter(u => u.role === 'student')
        .sort((a, b) => (b.stars || 0) - (a.stars || 0));

      console.log('‚úÖ Found', students.length, 'students');

      if (students.length === 0) {
        studentsList.innerHTML = '<div class="no-data">No students yet</div>';
        return;
      }

      students.forEach((student, index) => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
          <div class="student-name">#${index + 1} - ${student.name || 'Unknown'}</div>
          <div class="student-email">${student.email || 'N/A'}</div>
          <div class="student-stats">
            <div class="stat">
              <div class="stat-val">‚≠ê ${student.stars || 0}</div>
              <div class="stat-label">Stars</div>
            </div>
            <div class="stat">
              <div class="stat-val">${student.lessons || 0}/5</div>
              <div class="stat-label">Lessons</div>
            </div>
          </div>
        `;
        studentsList.appendChild(card);
      });
    } else {
      studentsList.innerHTML = '<div class="no-data">No students found</div>';
    }
  } catch (error) {
    console.error('‚ùå Error loading students:', error);
    document.getElementById('studentsList').innerHTML = `<div class="no-data">Error: ${error.message}</div>`;
  }
}

async function loadSubmissions() {
  try {
    console.log('üìÅ Loading submissions...');
    const snapshot = await get(ref(db, 'assignments'));
    const tbody = document.getElementById('submissionsTable');
    tbody.innerHTML = '';

    let count = 0;

    if (snapshot.exists()) {
      const assignments = snapshot.val();
      
      for (const [uid, userAssignments] of Object.entries(assignments)) {
        if (uid === 'questionFile' || uid === 'assignments') {
          console.log('‚è≠Ô∏è Skipping:', uid);
          continue;
        }

        try {
          const userSnap = await get(ref(db, `users/${uid}`));
          const student = userSnap.exists() ? userSnap.val() : { name: 'Unknown', email: 'Unknown' };

          for (const [assignmentName, data] of Object.entries(userAssignments)) {
            const row = document.createElement('tr');
            const submittedDate = new Date(data.uploadedAt || 0).toLocaleDateString();
            
            row.innerHTML = `
              <td>${student.name || 'Unknown'}</td>
              <td>${student.email || 'Unknown'}</td>
              <td>${data.fileName || assignmentName}</td>
              <td>${submittedDate}</td>
              <td>
                <button class="download-btn" onclick="downloadSubmission('${data.fileData}', '${data.fileName || assignmentName}')">
                  üì• Download
                </button>
              </td>
            `;
            tbody.appendChild(row);
            count++;
          }
        } catch (error) {
          console.error('‚ùå Error with user:', uid, error);
        }
      }

      if (count === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No submissions yet</td></tr>';
      }

      console.log('‚úÖ Found', count, 'submissions');
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">No submissions yet</td></tr>';
    }
  } catch (error) {
    console.error('‚ùå Error loading submissions:', error);
    document.getElementById('submissionsTable').innerHTML = `<tr><td colspan="5" class="no-data">Error: ${error.message}</td></tr>`;
  }
}
</script>

</body>
</html>
