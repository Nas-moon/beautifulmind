<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lesson 1 ‚Äì Topic 1</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #eef4fa;
  color: #222;
}

header {
  background: #1b5583;
  color: white;
  padding: 1rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

header h1 {
  margin: 0.5em 0;
  font-size: 1.2rem;
  font-weight: 800;
}

.heado {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-btns {
  display: flex;
  gap: 10px;
  align-items: center;
}

.back, .map-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-family: 'Segoe UI', Verdana;
  font-weight: bold;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back {
  background-color: #e6eef4;
  color: #1b5583;
}

.back:hover { 
  background-color: #dbe7f0;
  transform: translateY(-2px);
}

.map-btn {
  background-color: #ffd700;
  color: #0f2f4a;
  font-weight: bold;
}

.map-btn:hover { 
  background-color: #ffc800;
  transform: translateY(-2px);
}

main {
  max-width: 900px;
  margin: 2rem auto;
  padding: 1.5rem;
  background: white;
  border-radius: 1.5rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

h2 { 
  color: #1b5583;
  margin-bottom: 1rem;
  font-size: 1.8rem;
}

.video-wrapper {
  margin-bottom: 1.5rem;
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.video-wrapper iframe {
  width: 100%;
  height: 450px;
  border: none;
  display: block;
}

button#nextBtn {
  background: linear-gradient(135deg, #1b5583, #0f3c5f);
  color: white;
  border: none;
  padding: 0.8rem 1.4rem;
  border-radius: 0.6rem;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(27, 85, 131, 0.3);
}

button#nextBtn:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(27, 85, 131, 0.4);
}

button#nextBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}

#progress {
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #666;
  font-weight: 600;
}

#star-bar {
  background: #fff;
  padding: 0.5rem 1rem;
  border-radius: 1rem;
  font-size: 1.2rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  border: 2px solid #ffd700;
  display: inline-block;
  margin-bottom: 1rem;
}

.star {
  position: fixed;
  font-size: 2rem;
  z-index: 9999;
  pointer-events: none;
  animation: fly 1s ease-in-out forwards;
}

@keyframes fly {
  0%   { transform: scale(1) translate(0,0); opacity: 1; }
  100% { transform: scale(0.3) translate(300px,-300px); opacity: 0; }
}

.confetti {
  position: fixed;
  width: 8px;
  height: 8px;
  background: #ffd700;
  top: 50%;
  left: 50%;
  opacity: 0.9;
  animation: fall 1s ease-out forwards;
  z-index: 1000;
  pointer-events: none;
}

@keyframes fall {
  to {
    transform: translate(
      calc(-100px + 200px * var(--x)),
      calc(200px + 300px * var(--y))
    );
    opacity: 0;
  }
}

@media (max-width: 768px) {
  .heado {
    flex-direction: column;
    gap: 10px;
  }

  .header-btns {
    width: 100%;
    gap: 10px;
  }

  .back, .map-btn {
    flex: 1;
    padding: 10px;
  }

  main {
    margin: 1rem;
    padding: 1rem;
  }

  .video-wrapper iframe {
    height: 300px;
  }
}
</style>
</head>

<body>

<header>
  <div class="heado">
    <h1>Lesson 1 ‚Ä¢ Topic 1 - Introduction</h1>
    <div class="header-btns">
      <button class="back" onclick="history.back()">‚Üê Back</button>
      <button class="map-btn" onclick="window.location.href='../lessonmap/lesson-map.html'">üó∫Ô∏è Map</button>
    </div>
  </div>
</header>

<main>
  <div id="star-bar">‚≠ê <span id="star-count">0</span></div>

  <h2>Introduction</h2>

  <div class="video-wrapper">
    <iframe
      src="https://drive.google.com/file/d/1EXp6Ecboy5Plkh2HJDrZwOt52RxL_ov-/preview"
      allow="autoplay"
      allowfullscreen
    ></iframe>
  </div>

  <button id="nextBtn" disabled>Proceed to Topic 2 ‚Üí</button>
  
  <p id="progress">
    ‚è±Ô∏è <span id="timerText">0/10</span> - Watch to unlock
  </p>
</main>

<script type="module">
import { getCurrentUser } from '../firebase-config.js';
import { completeTopicInFirebase, getProgressData } from '../progress-manager.js';

// ============================================
// CONFIG - CHANGE FOR EACH PAGE
// ============================================
const VIDEO_DURATION = 10; // seconds to watch before unlocking
const TOPIC_ID = "l1topic1";
const STARS_TO_EARN = 10;
const NEXT_PAGE = "./l1topic2.html";
// ============================================

const nextBtn = document.getElementById("nextBtn");
const progressEl = document.getElementById("progress");
const starCountEl = document.getElementById("star-count");
const timerText = document.getElementById("timerText");

// ‚îÄ‚îÄ STEP 1: Check login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const user = getCurrentUser();

if (!user) {
  alert('‚ùå You are not logged in. Please log in first.');
  window.location.href = '../login.html';
} else {
  // Only runs if user is logged in
  console.log('‚úÖ User:', user.name, '| UID:', user.uid, '| Topic:', TOPIC_ID);
  init();
}

// ‚îÄ‚îÄ STEP 2: Main init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  await loadCurrentStars();
  await checkCompletion();
}

// ‚îÄ‚îÄ Load star count from Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCurrentStars() {
  try {
    const progressData = await getProgressData(user.uid);
    starCountEl.textContent = progressData.stars;
  } catch (e) {
    console.error('Could not load stars:', e);
  }
}

// ‚îÄ‚îÄ Check if topic already done ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkCompletion() {
  try {
    const progressData = await getProgressData(user.uid);

    if (progressData.completedTopics && progressData.completedTopics[TOPIC_ID]) {
      // Already completed ‚Äî unlock immediately, no timer needed
      nextBtn.disabled = false;
      progressEl.textContent = "‚úÖ Already completed! Click to proceed.";
      console.log('‚úÖ Topic already completed before');
    } else {
      // Not done yet ‚Äî start the timer
      startTimer();
    }
  } catch (e) {
    console.error('Error checking completion:', e);
    // If Firebase fails, still start timer so page isn't stuck
    startTimer();
  }
}

// ‚îÄ‚îÄ Timer logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let starsEarned = false;

function startTimer() {
  let secondsWatched = 0;
  console.log('‚è±Ô∏è Timer started...');

  const timerInterval = setInterval(() => {
    secondsWatched++;
    timerText.textContent = `${secondsWatched}/${VIDEO_DURATION}`;
    console.log(`‚è±Ô∏è ${secondsWatched}/${VIDEO_DURATION}`);

    if (secondsWatched >= VIDEO_DURATION) {
      clearInterval(timerInterval);
      unlockAndEarnStars();
    }
  }, 1000);
}

// ‚îÄ‚îÄ Unlock button + save stars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function unlockAndEarnStars() {
  if (starsEarned) return; // prevent double earning
  starsEarned = true;

  console.log('üéâ Timer done! Unlocking button and saving stars...');

  nextBtn.disabled = false;
  progressEl.innerHTML = '‚úÖ Video watched! Click to proceed.';

  try {
    const result = await completeTopicInFirebase(user.uid, TOPIC_ID, STARS_TO_EARN);

    if (result.success) {
      starCountEl.textContent = result.totalStars;
      console.log(`‚úÖ Stars saved! Total: ${result.totalStars}`);
      rewardAnimation();
    } else {
      console.error('‚ùå Error saving stars:', result.error);
    }
  } catch (e) {
    console.error('‚ùå Firebase error:', e);
  }
}

// ‚îÄ‚îÄ Next button click ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
nextBtn.addEventListener('click', () => {
  if (nextBtn.disabled) return;
  nextBtn.disabled = true;
  nextBtn.textContent = 'Loading...';
  setTimeout(() => {
    window.location.href = NEXT_PAGE;
  }, 500);
});

// ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rewardAnimation() {
  flyStar();
  confettiBurst();
}

function flyStar() {
  const star = document.createElement("div");
  star.className = "star";
  star.textContent = "‚≠ê";
  star.style.left = "50%";
  star.style.top = "50%";
  document.body.appendChild(star);
  setTimeout(() => star.remove(), 1000);
}

function confettiBurst() {
  for (let i = 0; i < 15; i++) {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.setProperty("--x", Math.random());
    c.style.setProperty("--y", Math.random());
    c.style.background = ["#ffd700", "#ff6b6b", "#ffed4e"][i % 3];
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 1000);
  }
}
</script>

</body>
</html>
