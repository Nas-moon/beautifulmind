<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Beautiful Mind</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f5f5;
  color: #222;
}

header {
  background: #1b5583;
  color: white;
  padding: 1.5rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 800;
}

.header-buttons {
  display: flex;
  gap: 10px;
}

.logout-link {
  background: rgba(231, 76, 60, 0.8);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
}

.logout-link:hover {
  background: rgba(231, 76, 60, 1);
  transform: translateY(-2px);
}

.upload-questions-btn {
  background: #ffd700;
  color: #0f2f4a;
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
}

.upload-questions-btn:hover {
  background: #ffc800;
  transform: translateY(-2px);
}

main {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

.tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid #ddd;
}

.tab-btn {
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  font-size: 1rem;
}

.tab-btn.active {
  color: #1b5583;
  border-bottom-color: #1b5583;
}

.tab-btn:hover {
  color: #1b5583;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.students-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.student-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-left: 4px solid #1b5583;
}

.student-name {
  font-size: 1.2rem;
  font-weight: 700;
  color: #1b5583;
  margin-bottom: 0.5rem;
}

.student-email {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.student-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.stat {
  background: #f0f8ff;
  padding: 0.75rem;
  border-radius: 8px;
  text-align: center;
}

.stat-val {
  font-size: 1.5rem;
  font-weight: 900;
  color: #ffd700;
}

.stat-label {
  font-size: 0.8rem;
  color: #666;
  margin-top: 0.25rem;
}

.submissions-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.submissions-table th {
  background: #1b5583;
  color: white;
  padding: 1rem;
  text-align: left;
  font-weight: 700;
}

.submissions-table td {
  padding: 1rem;
  border-bottom: 1px solid #eee;
}

.submissions-table tr:hover {
  background: #f9f9f9;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: #666;
  font-size: 1.1rem;
}

.no-data {
  text-align: center;
  padding: 2rem;
  color: #999;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    gap: 1rem;
  }

  .header-buttons {
    width: 100%;
  }

  .header-buttons button {
    flex: 1;
  }

  .students-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<header>
  <h1>üë®‚Äçüíº Admin Dashboard</h1>
  <div class="header-buttons">
    <button class="upload-questions-btn" onclick="goToUpload()">üì§ Upload Questions</button>
    <button class="logout-link" onclick="logout()">üö™ Logout</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab(event, 'students')">üë• Students</button>
    <button class="tab-btn" onclick="switchTab(event, 'submissions')">üìÅ Submissions</button>
  </div>

  <!-- STUDENTS TAB -->
  <div id="students" class="tab-content active">
    <div id="studentsList" class="students-grid">
      <div class="loading">Loading students...</div>
    </div>
  </div>

  <!-- SUBMISSIONS TAB -->
  <div id="submissions" class="tab-content">
    <table class="submissions-table">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Email</th>
          <th>Assignment</th>
          <th>Submitted</th>
        </tr>
      </thead>
      <tbody id="submissionsTable">
        <tr>
          <td colspan="4" style="text-align: center; padding: 2rem;">Loading submissions...</td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyAEMgcKGhZpui2eEYFA6T6SeYvWB51uRD0",
  authDomain: "beautifulmind-19645.firebaseapp.com",
  databaseURL: "https://beautifulmind-19645-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "beautifulmind-19645",
  storageBucket: "beautifulmind-19645.firebasestorage.app",
  messagingSenderId: "799227957055",
  appId: "1:799227957055:web:6a7397f3c43c7a9ed54d8a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Check if user is logged in and is admin
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log('‚ùå Not logged in, redirecting to login');
    window.location.href = './login.html';
    return;
  }

  try {
    const userSnap = await get(ref(db, `users/${user.uid}`));
    if (!userSnap.exists() || userSnap.val().role !== 'admin') {
      console.log('‚ùå Not admin, redirecting to login');
      window.location.href = './login.html';
      return;
    }
    
    console.log('‚úÖ Admin logged in:', user.email);
    loadStudents();
    loadSubmissions();
  } catch (error) {
    console.error('Error checking admin:', error);
    window.location.href = './login.html';
  }
});

function switchTab(event, tabName) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
}

function logout() {
  if (confirm('Logout?')) {
    signOut(auth).then(() => {
      console.log('‚úÖ Logged out');
      window.location.href = './login.html';
    });
  }
}

function goToUpload() {
  window.location.href = './admin-upload-questions.html';
}

async function loadStudents() {
  try {
    console.log('üìä Loading students...');
    const snapshot = await get(ref(db, 'users'));
    const studentsList = document.getElementById('studentsList');
    studentsList.innerHTML = '';

    if (snapshot.exists()) {
      const allData = snapshot.val();
      const students = Object.entries(allData)
        .map(([uid, data]) => ({ uid, ...data }))
        .filter(u => u.role === 'student')
        .sort((a, b) => (b.stars || 0) - (a.stars || 0));

      console.log('‚úÖ Found', students.length, 'students');

      if (students.length === 0) {
        studentsList.innerHTML = '<div class="no-data">No students yet</div>';
        return;
      }

      students.forEach((student, index) => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
          <div class="student-name">#${index + 1} - ${student.name || 'Unknown'}</div>
          <div class="student-email">${student.email || 'N/A'}</div>
          <div class="student-stats">
            <div class="stat">
              <div class="stat-val">‚≠ê ${student.stars || 0}</div>
              <div class="stat-label">Stars</div>
            </div>
            <div class="stat">
              <div class="stat-val">${student.lessons || 0}/5</div>
              <div class="stat-label">Lessons</div>
            </div>
          </div>
        `;
        studentsList.appendChild(card);
      });
    } else {
      studentsList.innerHTML = '<div class="no-data">No students found</div>';
    }
  } catch (error) {
    console.error('‚ùå Error loading students:', error);
    document.getElementById('studentsList').innerHTML = `<div class="no-data">Error: ${error.message}</div>`;
  }
}

async function loadSubmissions() {
  try {
    console.log('üìÅ Loading submissions...');
    const snapshot = await get(ref(db, 'assignments'));
    const tbody = document.getElementById('submissionsTable');
    tbody.innerHTML = '';

    let submissionCount = 0;

    if (snapshot.exists()) {
      const assignments = snapshot.val();
      
      for (const [uid, userAssignments] of Object.entries(assignments)) {
        // Skip questionFile entry
        if (uid === 'questionFile') continue;

        const userSnap = await get(ref(db, `users/${uid}`));
        const student = userSnap.exists() ? userSnap.val() : { name: 'Unknown', email: 'Unknown' };

        for (const [assignmentType, data] of Object.entries(userAssignments)) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${student.name || 'Unknown'}</td>
            <td>${student.email || 'Unknown'}</td>
            <td>${assignmentType}</td>
            <td>${new Date(data.uploadedAt || 0).toLocaleDateString()}</td>
          `;
          tbody.appendChild(row);
          submissionCount++;
        }
      }

      if (submissionCount === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No submissions yet</td></tr>';
      }

      console.log('‚úÖ Found', submissionCount, 'submissions');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" class="no-data">No submissions yet</td></tr>';
    }
  } catch (error) {
    console.error('‚ùå Error loading submissions:', error);
    document.getElementById('submissionsTable').innerHTML = `<tr><td colspan="4" class="no-data">Error: ${error.message}</td></tr>`;
  }
}
</script>

</body>
</html>
