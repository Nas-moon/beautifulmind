<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Questions - Admin Panel</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f5f5;
}

header {
  background: #1b5583;
  color: white;
  padding: 1.5rem 2rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 800;
}

.header-buttons {
  display: flex;
  gap: 10px;
}

.back-btn {
  background: #ffd700;
  color: #0f2f4a;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.back-btn:hover {
  background: #ffc800;
  transform: translateY(-2px);
}

.logout-link {
  background: rgba(231, 76, 60, 0.8);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.logout-link:hover {
  background: rgba(231, 76, 60, 1);
  transform: translateY(-2px);
}

main {
  max-width: 700px;
  margin: 2rem auto;
  padding: 1.5rem;
  background: white;
  border-radius: 1.5rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

h2 {
  color: #1b5583;
  margin-bottom: 1rem;
  font-size: 1.8rem;
}

.description {
  color: #666;
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 2rem;
}

.upload-section {
  background: #f9f9f9;
  border: 2px dashed #1b5583;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
}

.upload-section h3 {
  color: #1b5583;
  margin-bottom: 1rem;
  font-size: 1.2rem;
}

.file-input-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
  margin-bottom: 1rem;
}

.file-input-wrapper input[type='file'] {
  position: absolute;
  left: -9999px;
}

.file-label {
  display: inline-block;
  background: #1b5583;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}

.file-label:hover {
  background: #0f3c5f;
  transform: translateY(-2px);
}

.file-name {
  margin-top: 1rem;
  color: #666;
  font-weight: 600;
  font-size: 0.95rem;
}

.upload-btn {
  display: block;
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #1b5583, #0f3c5f);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 1.5rem;
  transition: all 0.3s;
}

.upload-btn:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(27, 85, 131, 0.4);
}

.upload-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}

.status-message {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 8px;
  display: none;
  text-align: center;
  font-weight: 600;
  font-size: 0.95rem;
}

.status-message.success {
  background: #efe;
  color: #3c3;
  border-left: 4px solid #3c3;
  display: block;
}

.status-message.error {
  background: #fee;
  color: #c33;
  border-left: 4px solid #c33;
  display: block;
}

.status-message.loading {
  background: #eef;
  color: #33c;
  border-left: 4px solid #33c;
  display: block;
}

.current-file {
  background: #f0f8ff;
  padding: 1.5rem;
  border-radius: 8px;
  margin-top: 2rem;
  border-left: 4px solid #1b5583;
}

.current-file h4 {
  color: #1b5583;
  margin-bottom: 0.5rem;
}

.current-file p {
  color: #666;
  margin: 0.5rem 0;
}

.error-banner {
  background: #fee;
  color: #c33;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  border-left: 4px solid #c33;
  display: none;
}

.error-banner.show {
  display: block;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    gap: 1rem;
  }

  .header-buttons {
    width: 100%;
  }

  .header-buttons button {
    flex: 1;
  }

  main {
    margin: 1rem;
    padding: 1rem;
  }

  h2 {
    font-size: 1.4rem;
  }
}
</style>
</head>

<body>

<header>
  <h1>üì§ Upload Assignment Questions</h1>
  <div class="header-buttons">
    <button class="back-btn" id="backBtn">‚Üê Back</button>
    <button class="logout-link" id="logoutBtn">üö™ Logout</button>
  </div>
</header>

<main>
  <div class="error-banner" id="errorBanner"></div>

  <h2>Upload Question File</h2>

  <p class="description">
    Upload the assignment question PDF file that will be displayed to all students. Students will be able to download and view this file in the assignments section, then upload their completed answers as PDF attachment.
  </p>

  <div class="upload-section">
    <h3>üìÑ Upload Question File</h3>
    <p style="color: #666; margin-bottom: 1.5rem;">Select your PDF question file (max 10MB)</p>
    
    <div class="file-input-wrapper">
      <input type="file" id="fileInput" accept=".pdf" />
      <label for="fileInput" class="file-label">üìÑ Choose PDF</label>
    </div>
    
    <div class="file-name" id="fileName">No file selected</div>
    
    <button class="upload-btn" id="uploadBtn" disabled>üöÄ Upload File</button>
    
    <div class="status-message" id="statusMessage"></div>
  </div>

  <div class="current-file" id="currentFile" style="display: none;">
    <h4>üìã Current Question File:</h4>
    <p><strong id="currentFileName"></strong></p>
    <p id="currentFileDate" style="font-size: 0.9rem; color: #999;"></p>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
      ‚úÖ This file is now visible to all students in their Assignment section
    </p>
  </div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyAEMgcKGhZpui2eEYFA6T6SeYvWB51uRD0",
  authDomain: "beautifulmind-19645.firebaseapp.com",
  databaseURL: "https://beautifulmind-19645-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "beautifulmind-19645",
  storageBucket: "beautifulmind-19645.firebasestorage.app",
  messagingSenderId: "799227957055",
  appId: "1:799227957055:web:6a7397f3c43c7a9ed54d8a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

console.log('üîß Upload Questions page loaded');

// Check if user is admin
onAuthStateChanged(auth, async (user) => {
  console.log('üë§ Auth state changed, user:', user?.email);
  
  if (!user) {
    console.log('‚ùå No user logged in, redirecting to login');
    setTimeout(() => {
      window.location.href = './login.html';
    }, 500);
    return;
  }

  try {
    console.log('üîç Checking user role...');
    const userSnap = await get(ref(db, `users/${user.uid}`));
    
    if (!userSnap.exists()) {
      console.log('‚ùå User profile not found in database');
      showError('User profile not found. Contact admin.');
      return;
    }

    const userData = userSnap.val();
    console.log('üìä User data:', userData);

    if (userData.role !== 'admin') {
      console.log('‚ùå User is not admin. Role:', userData.role);
      showError('Admin access only. Redirecting...');
      setTimeout(() => {
        window.location.href = './login.html';
      }, 500);
      return;
    }
    
    console.log('‚úÖ Admin verified:', user.email);
    loadCurrentFile();
    setupButtons();
  } catch (error) {
    console.error('‚ùå Error checking admin:', error);
    showError('Error: ' + error.message);
  }
});

function setupButtons() {
  console.log('‚öôÔ∏è Setting up buttons');
  
  document.getElementById('backBtn').onclick = () => {
    console.log('‚Üê Back button clicked');
    window.location.href = './admin-dashboard.html';
  };

  document.getElementById('logoutBtn').onclick = () => {
    console.log('üîì Logout button clicked');
    if (confirm('Are you sure you want to logout?')) {
      signOut(auth).then(() => {
        console.log('‚úÖ Logged out');
        window.location.href = './login.html';
      }).catch((error) => {
        console.error('‚ùå Logout error:', error);
        showError('Error logging out: ' + error.message);
      });
    }
  };
  
  console.log('‚úÖ Buttons set up');
}

function showError(msg) {
  const banner = document.getElementById('errorBanner');
  banner.textContent = msg;
  banner.classList.add('show');
}

function clearError() {
  const banner = document.getElementById('errorBanner');
  banner.classList.remove('show');
}

const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const uploadBtn = document.getElementById('uploadBtn');
const statusMessage = document.getElementById('statusMessage');

function showStatus(msg, type) {
  statusMessage.textContent = msg;
  statusMessage.className = 'status-message ' + type;
}

fileInput.addEventListener('change', (e) => {
  console.log('üìÅ File selected');
  if (e.target.files.length > 0) {
    const file = e.target.files[0];
    console.log('üìÑ File name:', file.name, 'Size:', file.size, 'Type:', file.type);
    
    if (file.type !== 'application/pdf') {
      fileName.textContent = '‚ùå Please select a PDF file only';
      uploadBtn.disabled = true;
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
      fileName.textContent = '‚ùå File too large (max 10MB)';
      uploadBtn.disabled = true;
      return;
    }
    
    fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
    uploadBtn.disabled = false;
  }
});

uploadBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if (!file) {
    console.log('‚ùå No file selected');
    return;
  }

  console.log('üöÄ Starting upload:', file.name);
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'üì§ Uploading...';
  showStatus('‚è≥ Uploading...', 'loading');
  clearError();

  try {
    const reader = new FileReader();
    
    reader.onerror = (error) => {
      console.error('‚ùå File read error:', error);
      showStatus('‚ùå Error reading file', 'error');
      uploadBtn.textContent = 'üöÄ Upload File';
      uploadBtn.disabled = false;
    };

    reader.onload = async (e) => {
      try {
        console.log('üìñ File read successfully, uploading to Firebase...');
        const fileData = e.target.result;
        const questionRef = ref(db, 'assignments/questionFile');
        
        await set(questionRef, {
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          fileData: fileData,
          uploadedAt: Date.now(),
          uploadedBy: 'admin'
        });

        console.log('‚úÖ File uploaded to Firebase successfully!');
        showStatus('‚úÖ Question file uploaded successfully! Students can now see it.', 'success');
        uploadBtn.textContent = 'üöÄ Upload File';
        uploadBtn.disabled = true;
        fileInput.disabled = true;
        
        setTimeout(() => {
          loadCurrentFile();
          fileInput.disabled = false;
          fileName.textContent = 'No file selected';
          fileInput.value = '';
        }, 1500);

      } catch (error) {
        console.error('‚ùå Upload error:', error);
        showStatus('‚ùå Error uploading: ' + error.message, 'error');
        uploadBtn.textContent = 'üöÄ Upload File';
        uploadBtn.disabled = false;
      }
    };

    console.log('üìñ Starting to read file...');
    reader.readAsDataURL(file);

  } catch (error) {
    console.error('‚ùå Unexpected error:', error);
    showStatus('‚ùå Error: ' + error.message, 'error');
    uploadBtn.textContent = 'üöÄ Upload File';
    uploadBtn.disabled = false;
  }
});

async function loadCurrentFile() {
  try {
    console.log('üìÇ Loading current question file...');
    const snapshot = await get(ref(db, 'assignments/questionFile'));
    const currentFileDiv = document.getElementById('currentFile');
    
    if (snapshot.exists()) {
      const data = snapshot.val();
      const date = new Date(data.uploadedAt).toLocaleDateString();
      const fileSize = ((data.fileSize || 0) / 1024 / 1024).toFixed(2);

      console.log('‚úÖ Current file found:', data.fileName);
      document.getElementById('currentFileName').textContent = data.fileName;
      document.getElementById('currentFileDate').textContent = `Uploaded: ${date} | Size: ${fileSize}MB`;
      currentFileDiv.style.display = 'block';
    } else {
      console.log('‚ÑπÔ∏è No question file uploaded yet');
      currentFileDiv.style.display = 'none';
    }
  } catch (error) {
    console.error('‚ùå Error loading current file:', error);
  }
}
</script>

</body>
</html>
