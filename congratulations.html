<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Congratulations - Beautiful Mind</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to bottom, #0f2f4a 0%, #1b5583 60%, #164b73 100%);
  min-height: 100vh;
  overflow: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  width: 300px;
  height: 300px;
  background: white;
  border-radius: 50%;
  opacity: 0.1;
  top: -100px;
  right: -100px;
  animation: float 20s infinite ease-in-out;
  z-index: 0;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(30px); }
}

main {
  position: relative;
  z-index: 1;
  padding: 20px;
  max-width: 600px;
  margin: 0 auto;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.congrats-card {
  background: linear-gradient(135deg, #1b5583 0%, #0f3c5f 100%);
  border-radius: 24px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  border: 2px solid rgba(255,215,0,0.3);
  padding: 40px 30px;
  text-align: center;
  animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  overflow-y: auto;
  max-height: 90vh;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.trophy-icon {
  font-size: 5rem;
  margin-bottom: 20px;
  display: block;
  animation: bounce 1s ease-in-out infinite 0.3s;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

h1 {
  color: #ffd700;
  font-size: 2.8rem;
  font-weight: 900;
  margin: 20px 0;
  text-shadow: 0 4px 12px rgba(255,215,0,0.3);
  letter-spacing: 2px;
}

.subtitle {
  color: #e6eef4;
  font-size: 1.2rem;
  margin: 15px 0 30px;
  opacity: 0.95;
  font-weight: 500;
}

.achievement-section {
  background: rgba(88,204,2,0.15);
  border: 2px solid rgba(88,204,2,0.4);
  border-radius: 16px;
  padding: 25px;
  margin: 25px 0;
}

.achievement-badge {
  font-size: 3rem;
  margin-bottom: 12px;
}

.achievement-title {
  color: #e6eef4;
  font-size: 1.4rem;
  font-weight: 800;
  margin: 12px 0;
}

.achievement-text {
  color: rgba(230,238,244,0.8);
  font-size: 0.95rem;
  margin: 0;
  font-weight: 500;
  line-height: 1.6;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 12px;
  margin: 25px 0;
}

.stat-box {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,215,0,0.2);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-box:hover {
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,215,0,0.4);
  transform: translateY(-4px);
}

.stat-icon {
  font-size: 2rem;
  margin-bottom: 8px;
}

.stat-label {
  color: rgba(230,238,244,0.7);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.stat-value {
  color: #ffd700;
  font-size: 1.6rem;
  font-weight: 900;
}

.leaderboard-box {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,215,0,0.2);
  border-radius: 12px;
  padding: 16px;
  margin: 25px 0;
  max-height: 200px;
  overflow-y: auto;
}

.leaderboard-box h3 {
  color: #ffd700;
  font-size: 1rem;
  margin: 0 0 12px 0;
  text-align: center;
}

.lb-preview-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.04);
  border-radius: 8px;
  font-size: 0.85rem;
}

.lb-preview-item.me {
  background: rgba(88,204,2,0.2);
  border-left: 3px solid rgba(88,204,2,0.6);
  padding-left: 5px;
}

.lb-preview-rank {
  color: #ffd700;
  font-weight: 900;
  min-width: 28px;
}

.lb-preview-name {
  flex: 1;
  color: #e6eef4;
  font-weight: 600;
}

.lb-preview-stars {
  color: #ffd700;
  font-weight: 700;
}

.certificate-box {
  background: rgba(255,215,0,0.1);
  border: 2px dashed rgba(255,215,0,0.4);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin: 25px 0;
}

.certificate-icon {
  font-size: 2.5rem;
  margin-bottom: 12px;
  display: block;
}

.certificate-text {
  color: #e6eef4;
  font-size: 0.95rem;
  margin: 0 0 8px 0;
  line-height: 1.5;
}

.certificate-note {
  color: rgba(230,238,244,0.7);
  font-size: 0.85rem;
  margin: 0;
  font-style: italic;
}

.message-box {
  background: rgba(88,204,2,0.1);
  border-left: 4px solid rgba(88,204,2,0.6);
  border-radius: 8px;
  padding: 16px;
  margin: 25px 0;
}

.message-text {
  color: #e6eef4;
  font-size: 0.95rem;
  margin: 0;
  line-height: 1.6;
}

.actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 30px;
}

.btn {
  padding: 14px 20px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
  text-align: center;
}

.btn-primary {
  background: linear-gradient(135deg, #ffd700, #ffa500);
  color: #0f2f4a;
  box-shadow: 0 8px 20px rgba(255,215,0,0.3);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(255,215,0,0.4);
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: #e6eef4;
  border: 2px solid rgba(255,215,0,0.3);
}

.btn-secondary:hover {
  background: rgba(255,255,255,0.15);
  border-color: rgba(255,215,0,0.5);
  transform: translateY(-3px);
}

.loading-text {
  text-align: center;
  color: rgba(230,238,244,0.6);
  padding: 20px;
  font-size: 0.9rem;
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  pointer-events: none;
  z-index: 1000;
  animation: confetti-fall 2s ease-out forwards;
}

@keyframes confetti-fall {
  0% {
    transform: translateY(-100%) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(500px) rotate(720deg);
    opacity: 0;
  }
}

@media (max-width: 480px) {
  main {
    padding: 15px;
  }

  .congrats-card {
    padding: 25px 20px;
  }

  h1 {
    font-size: 2rem;
  }

  .subtitle {
    font-size: 1rem;
  }

  .trophy-icon {
    font-size: 3.5rem;
  }

  .actions {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<main>
  <div class="congrats-card">
    <div class="trophy-icon">üèÜ</div>
    <h1>CONGRATULATIONS!</h1>
    <p class="subtitle">You've Completed Your Learning Journey</p>

    <div class="achievement-section">
      <div class="achievement-badge">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
      <h2 id="studentName" class="achievement-title">Loading...</h2>
      <p class="achievement-text">Has Successfully Completed All 5 Lessons</p>
    </div>

    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-icon">üìö</div>
        <div class="stat-label">Lessons Completed</div>
        <div class="stat-value">5/5</div>
      </div>

      <div class="stat-box">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-label">Total Stars</div>
        <div class="stat-value" id="totalStarsDisplay">0</div>
      </div>

      <div class="stat-box">
        <div class="stat-icon">üèÖ</div>
        <div class="stat-label">Your Rank</div>
        <div class="stat-value" id="rankDisplay">#-</div>
      </div>
    </div>

    <div class="leaderboard-box">
      <h3>üèÖ Your Position on Leaderboard</h3>
      <div id="lbPreview">
        <div class="loading-text">Loading...</div>
      </div>
    </div>

    <div class="certificate-box">
      <div class="certificate-icon">üéì</div>
      <p class="certificate-text">An official <strong>Certificate of Achievement</strong> will be sent to your registered email address shortly!</p>
      <p class="certificate-note">Keep an eye on your inbox üìß</p>
    </div>

    <div class="message-box">
      <p class="message-text">
        üåü <strong>Amazing Work!</strong> You've shown dedication and perseverance in completing this learning journey.
        <br><br>
        Keep up this momentum and continue to nurture your Beautiful Mind!
        <br><br>
        <em>‚Äî The Beautiful Mind Team</em>
      </p>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="viewLeaderboard">üèÜ View Leaderboard</button>
      <button class="btn btn-secondary" id="backHome">üè† Back to Map</button>
    </div>
  </div>
</main>

<script type="module">
import { getCurrentUser } from '../firebase-config.js';
import { getProgressData } from '../progress-manager.js';
import { db } from '../firebase-config.js';
import { ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// Check authentication
const user = getCurrentUser();
if (!user) {
  alert('‚ùå Not authenticated');
  window.location.href = '../login.html';
}

console.log('‚úÖ User:', user.name, 'Email:', user.email);

// Load data
async function loadData() {
  try {
    // Get progress
    const progressData = await getProgressData(user.uid);
    const totalStars = progressData.stars || 0;

    // Update name and stars
    document.getElementById('studentName').textContent = user.name;
    document.getElementById('totalStarsDisplay').textContent = totalStars;

    console.log('üìä Loaded - Stars:', totalStars);

    // Fetch leaderboard
    const snapshot = await get(ref(db, 'users'));
    const lbPreview = document.getElementById('lbPreview');
    lbPreview.innerHTML = '';

    if (snapshot.exists()) {
      const allUsers = snapshot.val();
      const students = Object.values(allUsers)
        .filter(u => u.role === 'student')
        .sort((a, b) => (b.stars || 0) - (a.stars || 0));

      const myIndex = students.findIndex(u => u.email === user.email);

      if (myIndex >= 0) {
        document.getElementById('rankDisplay').textContent = '#' + (myIndex + 1);
      }

      // Show top 3 + me
      const toShow = [];
      students.slice(0, 3).forEach(u => toShow.push(u));
      if (myIndex > 2) {
        toShow.push(students[myIndex]);
      }

      toShow.forEach((u) => {
        const isMe = u.email === user.email;
        const rank = students.findIndex(x => x.email === u.email) + 1;
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '#' + rank;

        const item = document.createElement('div');
        item.className = 'lb-preview-item' + (isMe ? ' me' : '');
        item.innerHTML = `
          <div class="lb-preview-rank">${medal}</div>
          <div class="lb-preview-name">${u.name || 'Unknown'}${isMe ? ' (You)' : ''}</div>
          <div class="lb-preview-stars">‚≠ê ${u.stars || 0}</div>
        `;
        lbPreview.appendChild(item);
      });

      console.log('üèÜ Leaderboard loaded - Your rank:', myIndex + 1);
    }

    createConfetti();

  } catch (error) {
    console.error('‚ùå Error loading data:', error);
    document.getElementById('studentName').textContent = user.name;
  }
}

function createConfetti() {
  const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a8e6cf'];

  for (let i = 0; i < 60; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * window.innerWidth + 'px';
    confetti.style.top = '-10px';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = Math.random() * 10 + 5 + 'px';
    confetti.style.height = confetti.style.width;
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    document.body.appendChild(confetti);

    setTimeout(() => confetti.remove(), 2500);
  }
}

// Button events
document.getElementById('viewLeaderboard').addEventListener('click', () => {
  window.location.href = '../lessonmap/lesson-map.html#leaderboard';
});

document.getElementById('backHome').addEventListener('click', () => {
  window.location.href = '../lessonmap/lesson-map.html';
});

loadData();
</script>

</body>
</html>
